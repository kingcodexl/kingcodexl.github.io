<!DOCTYPE HTML>
<html lang="zh-CN">


<head><meta name="generator" content="Hexo 3.9.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">
    <meta name="keywords" content="《程序员的自我修养》读书笔记——静态链接, Weslyxl">
    <meta name="description" content="
上一篇介绍了目标文件的格式，有了对结构的认识，这篇讲静态链接，主要是关于目标文件如何链接起来组成可执行文件。笔记后面把ld链接脚本语法省略，暂时用不到这么牛逼的武器。

本文导图

实验代码实验代码

a.c

extern int sh">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>《程序员的自我修养》读书笔记——静态链接 | Weslyxl</title>
    <link rel="icon" type="image/png" href="/favicon_w.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/css/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">
    <style type="text/css">
        
    </style>

    <script src="/libs/jquery/jquery-2.2.0.min.js"></script>
<link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"><!-- hexo-inject:begin --><!-- hexo-inject:end --></head>


<body>

<!-- hexo-inject:begin --><!-- hexo-inject:end --><header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="container">
            <div class="nav-wrapper">
                <div class="brand-logo">
                    <a href="/" class="waves-effect waves-light">
                        
                        <img src="/medias/logo_w.png" class="logo-img hide-on-small-only">
                        
                        <span class="logo-span">Weslyxl</span>
                    </a>
                </div>
                

<a href="#" data-activates="mobile-nav" class="button-collapse"><i class="fa fa-navicon"></i></a>
<ul class="right">
    
    <li class="hide-on-med-and-down">
        <a href="/" class="waves-effect waves-light">
            
            <i class="fa fa-home"></i>
            
            <span>首页</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/tags" class="waves-effect waves-light">
            
            <i class="fa fa-tags"></i>
            
            <span>标签</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/categories" class="waves-effect waves-light">
            
            <i class="fa fa-bookmark"></i>
            
            <span>分类</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/archives" class="waves-effect waves-light">
            
            <i class="fa fa-archive"></i>
            
            <span>归档</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/about" class="waves-effect waves-light">
            
            <i class="fa fa-user-circle-o"></i>
            
            <span>关于</span>
        </a>
    </li>
    
    <li class="hide-on-med-and-down">
        <a href="/friends" class="waves-effect waves-light">
            
            <i class="fa fa-address-book"></i>
            
            <span>友情链接</span>
        </a>
    </li>
    
    <li>
        <a id="toggleSearch" class="waves-effect waves-light">
            <i id="searchIcon" class="mdi-action-search" title="搜索"></i>
        </a>
    </li>

</ul>

<div class="side-nav" id="mobile-nav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo_w.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">Weslyxl</div>
        <div class="logo-desc">
            
            技术，业务一样重要
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li>
            <a href="/" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-home"></i>
                
                首页
            </a>
        </li>
        
        <li>
            <a href="/tags" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-tags"></i>
                
                标签
            </a>
        </li>
        
        <li>
            <a href="/categories" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-bookmark"></i>
                
                分类
            </a>
        </li>
        
        <li>
            <a href="/archives" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-archive"></i>
                
                归档
            </a>
        </li>
        
        <li>
            <a href="/about" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-user-circle-o"></i>
                
                关于
            </a>
        </li>
        
        <li>
            <a href="/friends" class="waves-effect waves-light">
                
                <i class="fa fa-fw fa-address-book"></i>
                
                友情链接
            </a>
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/zhijianshusheng" class="waves-effect waves-light" target="_blank">
                <i class="fa fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>

    <div class="social-link">


    <a href="mailto:weslywxl@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>




</div>
</div>

            </div>
        </div>

        
        <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/zhijianshusheng" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>
</header>





<div class="bg-cover post-cover" style="background-image: url('/medias/featureimages/16.jpg')">
    <div class="container">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <div class="description center-align post-title">
                        《程序员的自我修养》读书笔记——静态链接
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        margin: 35px 0 15px 0;
        padding-left: 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #toc-content .is-active-link::before {
        background-color: #42b983;
    }
</style>
<div class="row">
    <div class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                          <div class="article-tag">
                            <span class="chip bg-color">无标签</span>
                          </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fa fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/读书笔记/" class="post-category" target="_blank">
                                读书笔记
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                <div class="post-date info-break-policy">
                    <i class="fa fa-calendar-minus-o fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2018-04-02
                </div>

                
                    
                    <div class="info-break-policy">
                        <i class="fa fa-file-word-o fa-fw"></i>文章字数:&nbsp;&nbsp;
                        5.8k
                    </div>
                    

                    
                    <div class="info-break-policy">
                        <i class="fa fa-clock-o fa-fw"></i>阅读时长:&nbsp;&nbsp;
                        21 分
                    </div>
                    
                
				
				
            </div>
        </div>
        <hr class="clearfix">
        <div class="card-content article-card-content">
            <div id="articleContent">
                <blockquote>
<p>上一篇介绍了<a href="https://www.jianshu.com/p/dd9b6b66ef25" target="_blank" rel="noopener">目标文件的格式</a>，有了对结构的认识，这篇讲静态链接，主要是关于目标文件如何链接起来组成可执行文件。笔记后面把ld链接脚本语法省略，暂时用不到这么牛逼的武器。</p>
</blockquote>
<p>本文导图<br><img src="https://upload-images.jianshu.io/upload_images/664334-291434e5d490db67.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<a id="more"></a>
<h1 id="实验代码"><a href="#实验代码" class="headerlink" title="实验代码"></a>实验代码</h1><p>实验代码</p>
<ul>
<li>a.c</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">int</span> shared<span class="token punctuation">;</span>
<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> a <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token function">swap</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>a<span class="token punctuation">,</span> <span class="token operator">&amp;</span>shared<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<ul>
<li>b.c</li>
</ul>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">int</span> shared <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span> a<span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token operator">*</span> b<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">*</span>a <span class="token operator">^</span><span class="token operator">=</span> <span class="token operator">*</span>b <span class="token operator">^</span><span class="token operator">=</span> <span class="token operator">*</span>a <span class="token operator">^</span><span class="token operator">=</span> <span class="token operator">*</span>b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>对上面内容的解释：</p>
<ul>
<li>b中定义两个全局符号，变量shared和函数swap</li>
<li>a中定义了一个全局符号main</li>
<li>a中引用到了b中的swap和shared</li>
</ul>
<h1 id="空间地址分配"><a href="#空间地址分配" class="headerlink" title="空间地址分配"></a>空间地址分配</h1><p><strong>链接额过程就是将输入的目标文件合并为一个输出的可执行文件</strong>。如何将目标文件的各个段合并到可执行文件中，也就是空间如何分配，总体有如下两种方式，<strong>按序叠加与相似段合并</strong>。——合并规则</p>
<p>按序叠加很简单，就是按照目标文件的顺序叠加起来，可以用下图说明：<br><img src="https://upload-images.jianshu.io/upload_images/664334-37840aa80dbebd5f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<ul>
<li>如果可执行文件成千上百个目标文件组成，就会出现很多零散的段，每个目标文件都有三个最为核心的段，这样就会非常浪费空间，<strong>因为每个段都需要有一定的地址和空间对其要求。</strong>比如x86来说，段的装载地址和空间对其单位是页，也就是4096字节（一个页大小是4096字节），会造成极大的内存空间碎片。</li>
<li>关于内存地址对其可以看看<a href="https://levphy.github.io/2017/03/23/memory-alignment.html" target="_blank" rel="noopener">内存对齐规则之我见</a>，简单来讲就是因为<strong>CPU是按字读取内存。所以内存对齐的话，不会出现某个类型的数据读一半的情况，需要再二次读取内存。可以提升访问效率。编译器想通过空间换时间，通过适当增加padding，使每个成员的访问都在一个指令里完成，而不需要两次访问再拼接。</strong></li>
</ul>
<p>相似段合并这种方式更加实际，比如讲.text段合并到可执行文件的.text段，各个段一次合并。如下图所示：<br><img src="https://upload-images.jianshu.io/upload_images/664334-e150e0c5ba11dfc0.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>链接器为目标文件分配地址空间有两层含义：</p>
<ul>
<li>一个是在输出可执行文件中的空间</li>
<li>另一个是装载后的虚拟地址中的虚拟地址空间</li>
<li>之前提到过.bbs段，在可执行文件中并不占用文件空间，但是在占用虚拟地址空间，因为.bbs段在在文件中并没有内容。</li>
</ul>
<blockquote>
<p>目前只讨论关于虚拟地址空间的分配</p>
</blockquote>
<p>具体来讲链接器空间分配策略都是用第二中，并且采用两步链接。</p>
<ul>
<li>第一步：空间与地址分配——扫描所有目标文件，得到各个段的长度，将所有目标文件的符号表中的符号定义及引用信息统一放到一个全局符号表。可以根据目标文件的段长度，将他们合并，建立映射关系。</li>
<li>第二步：符号解析与重定位——根据上面的信息，读取文件中的段数据，重定位信息，进行符号解析与重定位，调整代码地址。<strong>这一步才是狠心，尤其是重定位。</strong></li>
</ul>
<p>用ld将a.o、b.o连接起来</p>
<p>Linux</p>
<pre><code>ld a.o b.o -e main -o ab</code></pre><p>Mac</p>
<pre><code>ld a.o b.o -e _main -o ab</code></pre><p>ld命令的两个参数含义是：</p>
<pre><code>-o：指定输出文件名；
-e：指定程序的入口符号。</code></pre><p>链接之后各个段的属性</p>
<p>Linux</p>
<p><img src="https://upload-images.jianshu.io/upload_images/664334-9bbb1180534f8f37.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>Mac</p>
<pre><code>$ objdump -h a.o

a.o:    file format Mach-O 64-bit x86-64

Sections:
Idx Name          Size      Address          Type
  0 __text        0000002e 0000000000000000 TEXT
  1 __compact_unwind 00000020 0000000000000030 DATA
  2 __eh_frame    00000040 0000000000000050 DATA

$ objdump -h b.o

b.o:    file format Mach-O 64-bit x86-64

Sections:
Idx Name          Size      Address          Type
  0 __text        0000002c 0000000000000000 TEXT
  1 __data        00000004 000000000000002c DATA
  2 __compact_unwind 00000020 0000000000000030 DATA
  3 __eh_frame    00000040 0000000000000050 DATA

$ objdump -h ab

ab:    file format Mach-O 64-bit x86-64

Sections:
Idx Name          Size      Address          Type
  0 __text        0000005c 0000000000001f20 TEXT
  1 __eh_frame    00000080 0000000000001f80 DATA
  2 __data        00000004 0000000000002000 DATA</code></pre><p>在Linux中VMA表示的是虚拟地址，LMA表示的是加载地址，一般这两个值一样，但是有些嵌入式系统中会不一样。Mac中只有一个地址也就是虚拟地址。</p>
<p>现在直接看VMA和SIZE，暂时忽略文件偏移。<strong>在链接之前虚拟地址都是零（MAC上起始的.text段为0），因为虚拟地址空间还没有分配，所以默认都是0，但是链接之后，可执行文件ab各个段都分配了相应的虚拟地址，所以可以看到text已经分配到地址。</strong></p>
<p>对应到Linux中ELF文件，<code>.text</code>段分配到了0x08048094，大小是0x72字节，<code>.data</code>段从地址0x08049108开始，大小为四字节。总体来说如下图：<br><img src="https://upload-images.jianshu.io/upload_images/664334-ca093deba689074b.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>为什么不从虚拟地址的0地址开始分配呢。涉及到操作系统进程虚拟地址的分配规则。Linux下ELF文件默认从0x08048000开始分配的。</p>
<h2 id="符号地址的确定"><a href="#符号地址的确定" class="headerlink" title="符号地址的确定"></a>符号地址的确定</h2><p>第一步过程中确定了在可执行文件中的空间分布。比如<code>.text</code>其实段0x08040894，<code>.data</code>段其实地址0x08049108.</p>
<p>第一步完成之后，链接器就开始计算各个符号的虚拟地址。<strong>符号在段内的位置是固定的，比如main、shared、wap地址已经是确定的了，只不过需要链接器给每个符号添加一个偏移量。</strong></p>
<p>比如a.o中的main函数相对于a.o的text偏移量是X，经过链接之后a.o的text段位于虚拟地址0x08048094,那么main的地址就是0x08048094+X。从前面的objdump可以看到main位于a.o的text段偏移是0。所以main这个符号最终在可执行文件中的地址是0x08048094+0。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/664334-b0c9486d653f2a53.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<h1 id="符号解析、重定位"><a href="#符号解析、重定位" class="headerlink" title="符号解析、重定位"></a>符号解析、重定位</h1><p>完成了空间和地址分配，链接器开始进行符号解析及重定位。</p>
<p>使用objdump的参数d查看反汇编结果</p>
<p>未链接a.o反汇编结果</p>
<p>Mac 下</p>
<pre><code>$ objdump -d a.o

a.o:    file format Mach-O 64-bit x86-64

Disassembly of section __TEXT,__text:
_main:
       0:    55     pushq    %rbp
       1:    48 89 e5     movq    %rsp, %rbp
       4:    48 83 ec 10     subq    $16, %rsp
       8:    48 8d 7d fc     leaq    -4(%rbp), %rdi
       c:    48 8b 35 00 00 00 00     movq    (%rip), %rsi
      13:    c7 45 fc 64 00 00 00     movl    $100, -4(%rbp)
      1a:    b0 00     movb    $0, %al
      1c:    e8 00 00 00 00     callq    0 &lt;_main+0x21&gt;
      21:    31 c9     xorl    %ecx, %ecx
      23:    89 45 f8     movl    %eax, -8(%rbp)
      26:    89 c8     movl    %ecx, %eax
      28:    48 83 c4 10     addq    $16, %rsp
      2c:    5d     popq    %rbp
      2d:    c3     retq</code></pre><p>Linux下：<br><img src="https://upload-images.jianshu.io/upload_images/664334-283999b8f255baee.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>可执行文件ab反汇编结果：<br>Mac 下：</p>
<pre><code>objdump -d ab

ab:    file format Mach-O 64-bit x86-64

Disassembly of section __TEXT,__text:
......

_main:
    1f20:    55     pushq    %rbp
    1f21:    48 89 e5     movq    %rsp, %rbp
    1f24:    48 83 ec 10     subq    $16, %rsp
    1f28:    48 8d 7d fc     leaq    -4(%rbp), %rdi
    1f2c:    48 8d 35 cd 00 00 00     leaq    205(%rip), %rsi
    1f33:    c7 45 fc 64 00 00 00     movl    $100, -4(%rbp)
    1f3a:    b0 00     movb    $0, %al
    1f3c:    e8 0f 00 00 00     callq    15 &lt;_swap&gt;
    1f41:    31 c9     xorl    %ecx, %ecx
    1f43:    89 45 f8     movl    %eax, -8(%rbp)
    1f46:    89 c8     movl    %ecx, %eax
    1f48:    48 83 c4 10     addq    $16, %rsp
    1f4c:    5d     popq    %rbp
    1f4d:    c3     retq
    1f4e:    90     nop
    1f4f:    90     nop

......</code></pre><p>Linux下<br><img src="https://upload-images.jianshu.io/upload_images/664334-38d3e11ae3691af1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<blockquote>
<p>需要懂点汇编才能理解上面的不同。主要是想说明，被引用的函数或者变量的地址，在链接之后被重新定位了。如上面的swap函数、shared变量。</p>
</blockquote>
<p><strong>关于汇编的学习后面会专门写一篇！</strong></p>
<h2 id="重定位表"><a href="#重定位表" class="headerlink" title="重定位表"></a>重定位表</h2><p>链接器通过重定位表才能知道哪些指令需要被调整，重定位表往往是一个或多个段。ELF必须包含重定位表来重新定位符号。</p>
<p>比如代码段<code>.text</code>有符号需要重定位，则就会有一个<code>.rel.text</code>的段保存了代码段重定位的信息，如果<code>.data</code>段中有重定位的地方，就会有一个对应的.<code>rel.data</code>段保存了数据端的重定位表。可以使用objdump的<code>r</code>参数查看。</p>
<p>Mac下：</p>
<pre><code>objdump -r a.o

a.o:    file format Mach-O 64-bit x86-64

RELOCATION RECORDS FOR [__text]:
000000000000001d X86_64_RELOC_BRANCH _swap
000000000000000f X86_64_RELOC_GOT_LOAD _shared@GOTPCREL

RELOCATION RECORDS FOR [__compact_unwind]:
0000000000000000 X86_64_RELOC_UNSIGNED __text</code></pre><p>Linux下：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/664334-7870e45aa714f9f8.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>可以看到a.o有两个重定位入口，<strong>重定位入口的偏移表示该符号入口在重定位段中的位置。</strong></p>
<blockquote>
<p>对上面代码的解析：因为还未进行链接,首先main函数其实地址为0x00000000。这个main函数占用了0x33个字节，17条指令。shared的引用是一条mov指令，一共8个字节，将shared的地址复制到ESP寄存器+4的偏移地址中，前四个是指令码，后面是shared的地址。暂时认为shared的地址是0x00000000，<strong>并且是绝对地址指令。</strong>。</p>
<p>其次对swap的调用的指令一个共5个字节，0xE8是操作码，这是个相对位移调用指令，后面四个字节就是函数 相对于调用指令的下一条指令的偏移量。没重定位之前，相对偏移量为0xFFFFFFFC（小端），常量<code>-4</code>的补码形式。</p>
</blockquote>
<ul>
<li>第一行表示这个重定位表是对代码段的重定位，所以偏移表示代码段中需要被调整的位置。对照前面的反汇编结构。这里的0x1c和0x27分别对应了代码段中的mov和call指令部分。</li>
</ul>
<p>重定位表中保存的是一个ELF32_Rel（intelx86）结构数组，表中每一个元素都对应一个重定位入口</p>
<pre><code>typedef struct {
    ELF32_Addr r_offset;
    ELF32_Word r_info;
}</code></pre><p>具体含义如下：<br><img src="https://upload-images.jianshu.io/upload_images/664334-b1f223b2c71b1cfa.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<blockquote>
<p>重定位表项里面包含了如何定位该符号的所有信息，偏移位置，类型，符号等。</p>
</blockquote>
<h2 id="符号解析"><a href="#符号解析" class="headerlink" title="符号解析"></a>符号解析</h2><p>符号未定义错误在链接的时候经常出现。对应上面的例子，</p>
<pre><code>ld a.o
ld: warning: -macosx_version_min not specified, assuming 10.11
ld: warning: object file (a.o) was built for newer OSX version (10.12) than being linked (10.11)
Undefined symbols for architecture x86_64:
  &quot;_shared&quot;, referenced from:
      _main in a.o
  &quot;_swap&quot;, referenced from:
      _main in a.o
  &quot;start&quot;, referenced from:
     implicit entry/start for main executable
ld: symbol(s) not found for inferred architecture x86_64</code></pre><p>导致符号未定义的原因很多（根本原因找不到符号），比如：</p>
<ul>
<li>链接时少了某个库</li>
<li>符号目标文本路径不正确</li>
</ul>
<blockquote>
<p>为什么缺少符号定义会导致链接错误？其实重定位过程伴随着符号解析的过程，每个目标文件可能定义一些符号，也可能引用的到其他文件中定义的符号，每个重定位入口都是对一个符号的引用。<strong>当链接器对某个符号进行重定位的时候，就需要确定这个符号的目标地址，这个时候就会去查找输入目标文件的符号表组成的全局符号表，找到这个符号然后重定位。</strong></p>
</blockquote>
<p>使用readelf -s查看符号表。</p>
<p>a.o中的符号表<br><img src="https://upload-images.jianshu.io/upload_images/664334-f822a74a55579eb2.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>注意上面的main、shared、swap都是GLOBAL。main函数定义在代码段之外，shared和swap是UND为定义。因为他们是定义哎其他目标文件中的。稳定一的都是需要在全局符号表中找到。</p>
<h2 id="指令修正"><a href="#指令修正" class="headerlink" title="指令修正"></a>指令修正</h2><blockquote>
<p>这部分需要结合在重定位反汇编用到的偏移量。</p>
</blockquote>
<p>不同处理器对于地址的格式和方式都不一样。常见的有跳转指令（jump 11种）、子程序调用指令（call 10种）、数据传送指令（mov 34中）寻址千差万别。差别如下：</p>
<ul>
<li>近址或远址寻址</li>
<li>绝对与相对寻址</li>
<li>寻址长度8、16、32、64位</li>
<li>相对近址32位寻址</li>
<li>绝对近址32位寻址</li>
</ul>
<p>每个被修正的长度为32位，4字节，都是近址寻址。区别就是相对或者绝对。之前说过，重定位入口r_info成员低八位表示重定位入口类型</p>
<p><img src="https://upload-images.jianshu.io/upload_images/664334-d898a7501a982583.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p>对应到上面的内容。swap符号的引用类型为R_386_PC32，代表是相对位移调用指令，而shared是R_386_32类型，他修正的是一条传输指令的原，shared的绝对地址。</p>
<blockquote>
<p>绝对寻址修正和相对寻址修正的区别就是前者修正后的地址就是该符号的实际地址，而后者修正后的地址为符号距离被修正位置的地址差。</p>
</blockquote>
<p>现在来计算一下，<strong>假设链接之后main函数的虚拟地址为0x1000，swap函数的地址为0x2000，shared变量的虚拟地址为0x3000。现在开始修正这两个重定位符号的地址。</strong></p>
<h3 id="shared"><a href="#shared" class="headerlink" title="shared"></a>shared</h3><p>根据上面的分析，首先shared是一个绝对寻址修正，结果应该是S（实际虚拟地址——假设的）+ A（修正位置的值——从符号解析中得到的value）</p>
<p>那么修正之后的地址就是：0x3000 + 0x0000000 = 0x3000。那么就应该是：<br><img src="https://upload-images.jianshu.io/upload_images/664334-7a989b0f0c244fe1.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<h3 id="swap"><a href="#swap" class="headerlink" title="swap"></a>swap</h3><p>swap需要相对修正，器修正地址就是S + A - P（被修正的位置，当链接的时候这个值就是被修正位置的虚拟地址 就为0x1000(main函数地址）+ 0x27）</p>
<p>对应下来：0x2000 + (-4) - (0x1000 + 0x27) = 0xFD5：</p>
<p>那么这条相对唯一调用指令地址是改指令下一条指令其实地址加上偏移量。那就是0x1026 + 0xfd5 = 0x2000。这就是swap函数的地址。</p>
<p><img src="https://upload-images.jianshu.io/upload_images/664334-2ff7b9eda6c0beab.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<h1 id="COMMON块"><a href="#COMMON块" class="headerlink" title="COMMON块"></a>COMMON块</h1><p>编译器将未初始化的全局变量定义作为弱符号，如上一篇的例子中global_uninit_var。使用<code>readelf -s</code>查看<br><img src="https://upload-images.jianshu.io/upload_images/664334-171f804fb9a221ce.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt><br>类型是一个SH_COMMON类型。</p>
<p><strong>当不同目标文件需要的COMMON块空间大小不一致的时候，以最大的那块为准。</strong></p>
<blockquote>
<p>需要使用COMMON机制的原因是编译器和链接器允许不同类型的弱符号存在，但是最本质的还是链接器不支持符号类型，也就是链接器无法判断各个符号类型是否一致。</p>
</blockquote>
<p><strong>小结：如果编译单元包含了弱符号（比如未初始化的全局变量就是典型的），那么弱符号最终占有多大空间不知道，所以编译器无法为改符号在BSS段分配空间。但是在链接过程中，弱符号大小可以确定了，所以最终在输出可执行文件的BBS段为弱符号分配空间。最终未初始化的全局变量还是放在BBS段</strong></p>
<h1 id="C-相关问题"><a href="#C-相关问题" class="headerlink" title="C++ 相关问题"></a>C++ 相关问题</h1><p>C++语言特性太复杂，必须有编译器和链接器共同支持才能完成工作。关键在于：</p>
<ul>
<li>重复代码消除</li>
<li>全局构造与析构</li>
<li>特性：虚函数、函数重载、继承、异常等。<strong>这些数据结构复杂，往往在不同编译器和链接器之间不能通用，二进制兼容性很麻烦。</strong></li>
</ul>
<h2 id="重复代码消除"><a href="#重复代码消除" class="headerlink" title="重复代码消除"></a>重复代码消除</h2><p>C++中的模板本质来讲很像宏，当被实例化的时候，并不知道自己是否在别的编译单元被实例化，所以必定出现重复代码。如果不管这些重复代码的话，主要会有如下问题：</p>
<ul>
<li>空间浪费</li>
<li>地址教易出错：可能有两个指向同一个函数的指针不相等。</li>
<li>指令运行效率低：因为现代CPU都会对指令和数据进行缓存，同一份指令有多份副本，那么Cache的命中率就会很低。</li>
</ul>
<p>比较现实的做法：每个目标的实例代码都单独存放到一个段（段命名如<code>.gnu.linkonce.name</code>，name就是该函数模板修饰后的名称）里，每个段只包含一个模板实例。当别的编译单元也有同样模板实例的时候，就会生成相同的名字，最终链接器将他们合并到最后的代码段。</p>
<h2 id="函数级别链接"><a href="#函数级别链接" class="headerlink" title="函数级别链接"></a>函数级别链接</h2><p>现在的程序和库都非常庞大，一个目标文件可能包含成千上百个函数或者变量，当我们需要用到某个目标文件的一个函数或变量的时候，需要把珍格格文件链接进来，这样导致输出的文件也很多。</p>
<p>在C++编译器中，有个编译选项叫做函数几倍链接，这个的作用就是让所有的函数像前面的模板一样，<strong>单独保存到一个段里面</strong>。当链接器需要用到这个函数的时候，就会将它合并到输出文件，没有用到的函数就会被抛弃。<strong>这样的方式同样有问题，虽然减少了输出文件的长度，但是会减慢编译和链接的过程，并且所有函数保存到独立的短中，目标函数的短数量增加，重定位会因为短的数目增加而变得复杂，目标文件也会变得相对较大。</strong></p>
<h2 id="全局构造、析构"><a href="#全局构造、析构" class="headerlink" title="全局构造、析构"></a>全局构造、析构</h2><p>C/C++程序都是从main函数开始执行的，随着main函数结束而结束。在main函数之前为了程序能够顺利执行。需要<strong>初始化进程执行环境、如堆分配初始化、线程子系统等</strong>。C++的全局对象构造函数在这一时期被执行</p>
<p>Linux下一班程序的入口是<code>_start</code>，这个函数时Linux系统库（Glibc）的一部分。当程序与Glibc链接在一起形成可执行文件之后，<code>_start</code>就是程序初始化入口。<strong>程序初始化之后，会调用main函数来执行程序，main函数执行之后就会进行一些清理工作，然后结束进程。</strong></p>
<p>在ELF定义了两个特殊的段，</p>
<ul>
<li><code>.init</code>段在main函数之前的可执行指令。构成进程的初始化代码。所以在main函数调用之前，Glibc初始化部分会执行这个段的代码。</li>
<li><code>.fini</code>段保存着进程的终止代码指令。所以当main函数正常退出时，Glib会安排执行这个段中的代码。</li>
</ul>
<h2 id="C-、ABI"><a href="#C-、ABI" class="headerlink" title="C++、ABI"></a>C++、ABI</h2><p><strong>编译器有很多种，那么不同编译器产生的目标文件可不可以进链接呢?</strong></p>
<p>如果两个不同的编译器想要产生的目标文件能够正确的链接起来，那么这两个目标文件必须满足：</p>
<ul>
<li>采用相同的目标文件格式</li>
<li>拥有相同的符号修饰标准</li>
<li>变量的内存分配方式相同</li>
<li>函数调用方式相同</li>
</ul>
<blockquote>
<p>把符号修饰标准、变量内存布局、函数调用方式等这些跟可执行的二进制文件兼容性相关的内容统称为ABI（应用程序二进制接口）。<strong>如果想弄清API和ABI的区别，可以看最后的扩展阅读内容呢。</strong></p>
</blockquote>
<ul>
<li>简单来讲就是API往往指源代码级别的接口，如POSIX是一个API标准，而ABI是二进制层面的级别。比如C++对象内存布局是C++ABI的一部分。</li>
<li>就拿POSIX规定printf()函数的原型为例，POSIX保证这个函数所有遵循POSIX标准的系统之间都一样，但是不保证printf在每个系统执行时，是否按照从右到左的参数压入堆栈。<strong>参数如何在堆栈中分配等这些实际运行时的二进制级别问题。</strong></li>
<li>由于各大硬件拼图，编程语言，编译，链接器和操作系统之间的ABI互相不兼容，所以哥哥目标文件之间无法互相链接。</li>
</ul>
<h3 id="实际例子"><a href="#实际例子" class="headerlink" title="实际例子"></a>实际例子</h3><p>对于C语言的目标来讲，一下几个方面会决定二进制是否兼容：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/664334-ae6d724f32011c81.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<p><strong>API相同ABI不一定相同。</strong></p>
<h1 id="链接过程控制"><a href="#链接过程控制" class="headerlink" title="链接过程控制"></a>链接过程控制</h1><p>一般情况下用链接器默认的链接规则就可以了，但是在一些特殊的情况下就需要自定义一些参数了，比如引导程序、内核驱动程序就需要特殊的链接过程。</p>
<p>链接过程需要确定的内容：</p>
<ul>
<li>使用哪些目标文件</li>
<li>使用安歇库文件</li>
<li>是否在最终的可执行文件保留调试信息</li>
<li>输出文件格式（可执行文件、动态库、静态库）</li>
<li>….</li>
</ul>
<h2 id="链接控制脚本"><a href="#链接控制脚本" class="headerlink" title="链接控制脚本"></a>链接控制脚本</h2><p><strong>链接控制脚本就是用来控制链接行为的</strong></p>
<p>一般链接器有如下几种方式控制链接行为：</p>
<ul>
<li>使用命令行：给链接器指定参数，比如之前用的ld的-o、-e参数就属于这类。</li>
<li>链接指令存放到目标文件里面：编译器经常会通过这种方式给链接器传递指令。具体来讲比如在PE目标文件的.drectve段用来链接传递参数 。</li>
<li>链接控制脚本：最为灵活也是最为强大的控制方式</li>
</ul>
<p>之前我们在使用ld命令链接的时候，没有指定链接脚本，其实ld如果没有指定链接脚本，则会使用默认的链接脚本。在Linux上使用<code>ld -verbose</code>查看默认链接脚本。<strong>为了更加精确的控制链接过程，可以自己写一个链接脚本，然后指定该脚本控制脚本，比如<code>ld -T link.script</code></strong></p>
<h2 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h2><p>在这里例子中，作者没有使用main函数和c中的printf函数来打印helloword。而是使用了自定义的一套方式，使用了GCC内嵌汇编（<strong>不是很懂，没弄过</strong>），并且自定义了将所有段合并到一个叫做<code>tinytext</code>段中。</p>
<p>TinyHelloWord.c源码<br><img src="https://upload-images.jianshu.io/upload_images/664334-82c0f6857b416585.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<blockquote>
<p>看到后面懵逼了，暂时停下来去了解下汇编、复习下终端等知识。</p>
</blockquote>
<ul>
<li>句柄与普通指针的区别：指针包含的是引用对象的内存地址，而句柄则是由系统所管理的引用标识，该标识可以被系统重新定位到一个内存地址上。这种间接访问对象的模式增强了系统对引用对象的控制。</li>
</ul>
<h3 id="使用ld链接脚本"><a href="#使用ld链接脚本" class="headerlink" title="使用ld链接脚本"></a>使用ld链接脚本</h3><p>无奈是输出文件还是输入文件，主要的数据就是文件中的各个段。它们中的段我们称作输入段、输出段。控制链接果果就是把控制输入段如何变成输出段，比如</p>
<ul>
<li>哪些输入段要合并为一个输出段</li>
<li>哪些输入段要丢弃</li>
<li>指定输出段的名字、装载地址、属性</li>
</ul>
<p>比如上面TinyHelloword的链接脚本TinyHelloWorld.lds<br><img src="https://upload-images.jianshu.io/upload_images/664334-7ee306600500b076.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt></p>
<ul>
<li><p>第一行是ENTRY（nomain）指定了程序入口为nomain()函数</p>
</li>
<li><p>SECTIONS是链接脚本的主体，指定了各个输入段到输出段的交换。里面的大括号包含的是SECTIONS的变化规则。</p>
<ul>
<li>第一条是赋值语句<code>. = 0x08048000 + SIZEOF_HEADERS</code>表示把当前虚拟地址设置成为0x08048000 + SIZEOF_HEADERS</li>
<li><code>tinytext：{*（.text）*(.data)*(.rodata)}</code>第二条是个段转换规则，也就是后面的三个段合并输出到文件tinytext中</li>
<li><code>/DISCARD/:{*{comment}}</code>第三个意思就是丢弃所有输入文件中的名字为<code>.comment</code>内容，不保存到输出文件中。</li>
</ul>
<p>  <strong>默认情况下，<code>.shstrtab、.symtab、.strtab</code>代表段名字符串表，符号表和字符串表，这三种表，链接器在产生可执行文件的时候会自动生成。</strong>——可执行文件中，符号表和字符串是可选的，段名字符串表保存段名，必不可少。</p>
</li>
</ul>
<h2 id="ld链接脚本语法"><a href="#ld链接脚本语法" class="headerlink" title="ld链接脚本语法"></a>ld链接脚本语法</h2><p>这一小节直接看资料，<a href="http://www.aizhuanji.com/a/AWbaBakV.html" target="_blank" rel="noopener">ld链接脚本文件语法解析</a>。平时很难有机会用到这块知识。</p>
<h1 id="扩展阅读"><a href="#扩展阅读" class="headerlink" title="扩展阅读"></a>扩展阅读</h1><p><a href="https://en.wikipedia.org/wiki/ABI" target="_blank" rel="noopener">ABI-Application binary interface</a><br><a href="https://dirtysalt.github.io/html/gcc-asm.html#orgheadline2" target="_blank" rel="noopener">GCC内嵌汇编</a><br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-linuxkernelint/" target="_blank" rel="noopener">Linux 内核中断内幕</a><br><a href="https://www.zhihu.com/question/27656256" target="_blank" rel="noopener">句柄是什么？</a><br><a href="https://stackoverflow.com/questions/381244/purpose-of-memory-alignment" target="_blank" rel="noopener">Purpose of memory alignment</a><br><a href="http://www.cnblogs.com/azraelly/archive/2012/12/31/2840479.html" target="_blank" rel="noopener">内存地址对齐提升程序性能</a></p>

            </div>
            <hr/>

            

            <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">

<div id="article-share">
    
    <div class="social-share" data-disabled="qzone" data-wechat-qrcode-helper="<p>微信里点“发现”->“扫一扫”二维码便可查看分享。</p>"></div>
    
</div>

<script src="/libs/share/js/social-share.min.js"></script>

            <div class="reprint">
                <p>
                    <span class="reprint-tip">
                        <i class="fa fa-exclamation-circle"></i>&nbsp;&nbsp;转载请注明:
                    </span>
                    <a href="https://www.wxlong.tech" class="b-link-green">Weslyxl</a>
                    <i class="fa fa-angle-right fa-lg fa-fw text-color"></i>
                    <a href="/2018/04/02/2018/4/《程序员的自我修养》读书笔记——静态链接/" class="b-link-green">《程序员的自我修养》读书笔记——静态链接</a>
                </p>
            </div>
        </div>
    </div>

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fa fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2018/04/06/2018/4/Mac搭建虚拟CentOS服务器环境/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="Mac搭建虚拟CentOS服务器环境">
                        
                        <span class="card-title">Mac搭建虚拟CentOS服务器环境</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">
最初打算在阿里云买个云服务器来部署，后来一想完全可以用虚拟机先把整个流程跑一遍再买也不迟。先把坑踩完了，再直接去线上部署就会事半功倍。终有此文！




比较麻烦的是在设置网络的时候，一方面需要访问外网，一方面需要主机ssh登录，网上介绍</div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="fa fa-clock-o fa-fw icon-date"></i>2018-04-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/读书笔记/" class="post-category" target="_blank">
                                    读书笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fa fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2018/04/02/2018/4/《程序员的自我修养》读书笔记——目标文件/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/25.jpg" class="responsive-img" alt="《程序员的自我修养》读书笔记——目标文件">
                        
                        <span class="card-title">《程序员的自我修养》读书笔记——目标文件</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary">
上一篇介绍了编译连接的过程，提到了目标文件是通过汇编过程生成的，最终链接生成可执行文件，这篇介绍一下目标文件里面到底有什么。

本文导图


格式概述目标文件相对于最终的可执行文件而言，结构上已经和可执行文件的结构基本一样了。只是还没有经</div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="fa fa-clock-o fa-fw icon-date"></i>2018-04-02
                            </span>
                        <span class="publish-author">
                            
                            <i class="fa fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/读书笔记/" class="post-category" target="_blank">
                                    读书笔记
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
            </div>
        </div>
        
    </div>
</article>
</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('40')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: Weslyxl<br />'
            + '作者: weslyxl<br />'
            + '链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者wesly所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>

    </div>
    <div class="col l3 hide-on-med-and-down">
        <div class="toc-widget">
            <div class="toc-title"><i class="fa fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            // headingsOffset: -205,
            headingSelector: 'h1, h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h1, h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });
    });
</script>
    

</main>


<footer class="page-footer bg-color">
    <div class="container row center-align">
        <div class="col s12 m8 l8 copy-right">
             Copyright  ©️2019  Wesly
            <!-- 本站由&copy;<a href="https://blinkfox.github.io/" target="_blank">Blinkfox</a>基于
            <a href="https://hexo.io/" target="_blank">Hexo</a> 的
            <a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">hexo-theme-matery</a>主题搭建.

            
                &nbsp;<i class="fa fa-area-chart"></i>&nbsp;站点总字数:&nbsp;
                <span class="white-color">333.2k</span>
            

            
			 -->
        </div>
        <div class="col s12 m4 l4 social-link ">


    <a href="mailto:weslywxl@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fa fa-envelope-open"></i>
    </a>




</div>
    </div>
</footer>

<div class="progress-bar"></div>


<!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fa fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input" autofocus="">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script src="/js/search.js"></script>
<script type="text/javascript">
    searchFunc("/" + "search.xml", 'searchInput', 'searchResult');
</script>
<!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fa fa-angle-up"></i>
    </a>
</div>


<script src="/libs/materialize/js/materialize.min.js"></script>
<script src="/libs/masonry/masonry.pkgd.min.js"></script>
<script src="/libs/aos/aos.js"></script>
<script src="/libs/scrollprogress/scrollProgress.min.js"></script>
<script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
<script src="/js/matery.js"></script>

<!-- Global site tag (gtag.js) - Google Analytics --><!-- hexo-inject:begin --><!-- hexo-inject:end -->





</body>
</html>